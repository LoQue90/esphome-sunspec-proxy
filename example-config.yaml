# Hoymiles SunSpec Proxy - Example Configuration
#
# Bridges Hoymiles microinverters (via DTU-Pro RS-485) to Victron GX
# as a SunSpec Modbus TCP server. All sensors auto-generated.
#
# WIRING:
#   ESP32 RS485 (A+/B-/GND) <---> DTU-Pro RS-485 port (A/B/C)
#
# DTU-PRO SETUP:
#   1. Enable "Remote Control/Modbus Protocol" in Hoymiles installer app
#      (Me → Local Install Assistant → Home → DTU Information → RS485 port setting)
#   2. Set DTU Modbus address (101-254, e.g. 126)
#   3. Baud rate is fixed at 9600, 8N1
#
# PORT NUMBERS:
#   Port 0 = First inverter connected to DTU
#   Port 1 = Second inverter, etc.
#   (These correspond to the order shown in Hoymiles app)

esphome:
  name: sunspec-proxy
  friendly_name: SunSpec Proxy

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

logger:
  baud_rate: 0
  level: DEBUG

api:
  encryption:
    key: !secret api_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "SunSpec-Proxy Fallback"
    password: !secret ap_password

captive_portal:

# Import SunSpec proxy component from GitHub
external_components:
  - source:
      type: git
      url: https://github.com/Geoffn-Hub/esphome-sunspec-proxy
      ref: main
    components: [sunspec_proxy]

# UART for RS-485 to Hoymiles DTU-Pro
uart:
  id: uart_bus
  tx_pin: GPIO17       # Adjust for your board
  rx_pin: GPIO18       # Adjust for your board
  baud_rate: 9600
  rx_buffer_size: 512

# =============================================================
# SunSpec Proxy Configuration
# =============================================================
sunspec_proxy:
  id: sunspec_bridge
  uart_id: uart_bus
  tcp_port: 502                     # Modbus TCP port for Victron
  poll_interval_ms: 5000            # How often to poll all inverters
  rtu_timeout_ms: 3000              # Timeout for DTU response
  dtu_address: 126                  # DTU-Pro Modbus address (set in installer app)

  # Aggregated device identity (what Victron sees)
  unit_id: 126                      # SunSpec TCP unit ID
  phases: 3                         # Combined output phases
  rated_voltage_v: 230
  manufacturer: "Fronius"           # Best Victron compatibility
  model_name: "Hoymiles Bridge"
  serial_number: "HM-BRIDGE-001"

  # Physical inverters (ports on the DTU)
  rtu_sources:
    - port: 0                       # First inverter (Port 0)
      inverter_model: "HMS-2000-4T"
      name: "Inverter 1"
      connected_phase: 1            # Single-phase inverter on L1

    - port: 1                       # Second inverter (Port 1)
      inverter_model: "HMS-1000-2T"
      name: "Inverter 2"
      connected_phase: 2            # Single-phase inverter on L2

  # Aggregate sensors (combined output visible in HA)
  aggregate_sensors:
    power: true
    voltage: true
    current: true
    frequency: true
    energy: true

  # Bridge diagnostic sensors
  bridge_sensors:
    tcp_clients: true
    tcp_requests: true
    tcp_errors: true
    victron_connected: true
    power_limit: true
    dtu_serial: true                # DTU serial number (RS-485 link test)
    dtu_online: true                # DTU responding on RS-485?
    dtu_poll_success: true
    dtu_poll_fail: true

# Additional system sensors
sensor:
  - platform: uptime
    name: "Uptime"

  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s
