# Hoymiles SunSpec Proxy - Example Configuration
#
# Bridges Hoymiles microinverters (via DTU-Pro Modbus TCP) to Victron GX
# as a SunSpec Modbus TCP server. All sensors auto-generated.
#
# Copy this file, rename it, and customise for your setup.
# Create a secrets.yaml with your wifi_ssid and wifi_password.

esphome:
  name: waveshare-rs485
  friendly_name: WaveShare-RS485
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  flash_size: 16MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf

logger:
  baud_rate: 0
  level: DEBUG

api:
  encryption:
    key: !secret api_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Waveshare-Rs485 Fallback"
    password: !secret ap_password

network:
  enable_ipv6: True
  min_ipv6_addr_count: 2
  enable_high_performance: True

captive_portal:

external_components:
  - source:
      type: local
      path: components
    components: [sunspec_proxy]
    refresh: 0s

# =============================================================
# SunSpec Proxy Configuration
# =============================================================
sunspec_proxy:
  id: sunspec_bridge
  dtu_host: "192.168.1.100"         # Your DTU-Pro IP address
  dtu_port: 502                     # DTU Modbus TCP port
  dtu_address: 1                    # DTU Modbus unit ID
  tcp_port: 502                     # SunSpec server port for Victron
  poll_interval_ms: 5000
  tcp_timeout_ms: 3000

  # Aggregated device identity (what Victron sees)
  unit_id: 126
  phases: 3
  rated_voltage_v: 230
  manufacturer: "Fronius"           # Fronius for best Victron compatibility
  model_name: "Hoymiles Bridge"
  serial_number: "HM-BRIDGE-001"

  # Physical inverters
  # Serial numbers MUST match DTU register data (lowercase hex, no separators)
  rtu_sources:
    - port: 0
      inverter_model: "HMS-2000-4T"
      inverter_serial: "your_serial_here"
      name: "My Inverter"
      connected_phase: 1
      sensors:
        mppt_sensors: true

  aggregate_sensors:
    power: true
    voltage: true
    current: true
    frequency: true
    energy: true

  bridge_sensors:
    tcp_clients: true
    tcp_requests: true
    tcp_errors: true
    victron_connected: true
    power_limit: true

sensor:
  - platform: uptime
    name: "Uptime"
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

output:
  - platform: gpio
    id: output_led_status
    pin: GPIO2

light:
  - platform: binary
    id: led_status
    name: "Status LED"
    output: output_led_status

interval:
  - interval: 3s
    then:
      - light.turn_on: led_status
      - delay: 100ms
      - light.turn_off: led_status
